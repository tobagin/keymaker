# Design: AWS IAM Integration

## Context

AWS IAM uses a fundamentally different authentication model from OAuth providers:
- No browser-based flow (no redirect URLs)
- Authentication via Access Key ID + Secret Access Key
- Requests signed with AWS Signature Version 4
- No automatic token refresh (credentials are long-lived)
- Region-specific endpoints (e.g., `iam.us-east-1.amazonaws.com`)

This is the first non-OAuth provider in KeyMaker, requiring new authentication infrastructure.

## Goals / Non-Goals

### Goals
- Support AWS IAM SSH public key management
- Implement AWS Signature V4 request signing (no external AWS SDK)
- Secure storage of AWS credentials
- Region selection support
- Clear security warnings for credential handling

### Non-Goals
- EC2 key pair management (different from IAM SSH keys)
- AWS Organizations support (multi-account deferred to Phase 7)
- STS temporary credentials (AssumeRole, etc.)
- S3 or other AWS service integrations
- Full AWS SDK integration (too heavyweight)

## Decisions

### 1. Authentication: API Keys (Not OAuth)

**Decision**: Use AWS Access Key ID + Secret Access Key for authentication.

**Rationale**:
- AWS IAM doesn't support OAuth for programmatic access
- API keys are the standard authentication method for AWS SDKs/CLI
- Users already familiar with this model (aws configure)

**User Flow**:
1. User clicks "Configure Credentials" on AWS provider card
2. Dialog prompts for:
   - Access Key ID (e.g., `AKIAIOSFODNN7EXAMPLE`)
   - Secret Access Key (e.g., `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`)
   - AWS Region (default: us-east-1)
3. KeyMaker validates credentials by calling `iam:GetUser`
4. Credentials stored in Secret Service

### 2. AWS Signature Version 4 Implementation

**Decision**: Implement AWS Signature V4 manually using Vala + libsoup (no external SDK).

**Rationale**:
- AWS SDKs (boto3, aws-sdk-js) are too heavyweight (dozens of MB)
- Signature V4 is well-documented and straightforward
- Only need IAM API (not full AWS ecosystem)
- Reduces dependency footprint

**Algorithm** (simplified):
```
1. Canonical request = "POST\n/\n\nhost:iam.amazonaws.com\n\n..."
2. String to sign = "AWS4-HMAC-SHA256\n<timestamp>\n<scope>\nSHA256(canonical_request)"
3. Signing key = HMAC(HMAC(HMAC(HMAC("AWS4" + secret_key, date), region), "iam"), "aws4_request")
4. Signature = HMAC(signing_key, string_to_sign)
5. Authorization header = "AWS4-HMAC-SHA256 Credential=..., SignedHeaders=..., Signature=..."
```

**Implementation**:
- Create `AWSRequestSigner.vala` class
- Use GLib's `Checksum` for SHA256 hashing
- Use GLib's `Hmac` for HMAC-SHA256 signing
- Reuse libsoup for HTTP transport

### 3. IAM API Endpoints

**Decision**: Use AWS IAM API (not EC2 key pairs API).

**AWS IAM SSH Key Operations**:
- Base URL: `https://iam.amazonaws.com/` (global endpoint, not regional)
- List keys: `Action=ListSSHPublicKeys&UserName=<user>`
- Upload key: `Action=UploadSSHPublicKey&UserName=<user>&SSHPublicKeyBody=<key>`
- Delete key: `Action=DeleteSSHPublicKey&UserName=<user>&SSHPublicKeyId=<id>`
- Get key: `Action=GetSSHPublicKey&UserName=<user>&SSHPublicKeyId=<id>&Encoding=SSH`

**Why not EC2 key pairs?**:
- EC2 key pairs are region-specific and private key is generated by AWS
- IAM SSH keys are user-uploaded public keys (matches our use case)
- IAM keys work across all regions

### 4. Region Selection

**Decision**: Allow users to select AWS region, but default to `us-east-1`.

**Rationale**:
- IAM is global (not regional), but region is required for signature
- Region affects latency (users in EU should use eu-west-1)
- Most users default to us-east-1

**UI**:
- Dropdown in credentials dialog: "Region: us-east-1" (with common regions)
- Store in GSettings: `cloud-provider-aws-region`

### 5. Credential Storage

**Decision**: Store AWS credentials in Secret Service with separate entries for Access Key ID and Secret Access Key.

**Schema**:
```
Access Key ID:
  service = "keymaker-aws-access-key-id"
  account = <access_key_id>

Secret Access Key:
  service = "keymaker-aws-secret-access-key"
  account = <access_key_id>  # Use access key ID as lookup key
```

**Rationale**:
- Secret Service encrypts both (even though Access Key ID is less sensitive)
- Easy lookup by Access Key ID
- Follows GNOME security best practices

### 6. Username Retrieval

**Decision**: Call `iam:GetUser` to retrieve IAM username after credential validation.

**Rationale**:
- AWS API requires username for SSH key operations
- GetUser returns authenticated user's name
- Also serves as credential validation

### 7. Error Handling for AWS

**AWS-specific errors**:
- `AccessDenied`: Insufficient IAM permissions
- `InvalidClientTokenId`: Invalid Access Key ID
- `SignatureDoesNotMatch`: Incorrect Secret Access Key or signing bug
- `NoSuchEntity`: User or key doesn't exist
- `LimitExceeded`: AWS rate limit (rare for IAM API)

**Decision**: Map AWS error codes to user-friendly messages with actionable guidance.

## Risks / Trade-offs

### Risk 1: Signature V4 Implementation Bugs
**Risk**: Manual implementation of AWS Signature V4 might have bugs (wrong signing, timestamp issues).

**Mitigation**:
- Extensively test with AWS IAM API test suite
- Compare signing output with AWS CLI (aws iam list-ssh-public-keys --debug)
- Add unit tests for signature generation

**Trade-off**: More implementation work vs. avoiding heavyweight AWS SDK. Worth it for smaller binary size.

### Risk 2: IAM Permission Requirements
**Risk**: Users might provide credentials without `iam:*SSHPublicKey` permissions.

**Mitigation**:
- Document required IAM permissions in setup dialog
- Show error: "Insufficient permissions. Ensure your IAM user has iam:ListSSHPublicKeys, iam:UploadSSHPublicKey, iam:DeleteSSHPublicKey policies."
- Provide example IAM policy JSON in documentation

### Risk 3: Credential Leakage
**Risk**: AWS credentials are more dangerous than OAuth tokens (full account access).

**Mitigation**:
- Never log credentials (even in debug mode)
- Show security warning dialog before storing credentials
- Recommend IAM users with limited permissions (not root account)
- Add "Revoke Credentials" button that deletes from Secret Service

### Risk 4: No Automatic Credential Refresh
**Risk**: AWS credentials don't expire automatically (unlike OAuth tokens), so users might forget to rotate them.

**Mitigation**:
- Not a bug, it's AWS's design (long-lived credentials)
- Show last used date in UI: "Credentials last used: 3 days ago"
- Add optional reminder: "Consider rotating AWS credentials regularly"

## Migration Plan

N/A - Additive feature, no existing data.

## Open Questions

1. **Should we support AWS temporary credentials (STS)?**
   - Decision: No, Phase 4 uses long-lived IAM user credentials only. STS support can be Phase 10 if needed.

2. **Should we support AWS CLI credential files (~/.aws/credentials)?**
   - Decision: No, Phase 4 requires manual entry. Import from AWS CLI can be Phase 11 if requested.

3. **Should we validate IAM permissions before enabling features?**
   - Decision: Yes. Call `iam:ListSSHPublicKeys` on connect. If it fails with AccessDenied, show permission error.

4. **Should we support IAM roles (for EC2 instances)?**
   - Decision: No, Phase 4 targets desktop users with IAM user credentials. Role-based auth doesn't make sense for desktop apps.
